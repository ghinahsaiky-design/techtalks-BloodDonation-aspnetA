@using System.Linq

@model BloodDonation.Models.EditDonorProfileViewModel
@{
    string FirstName = Model.FirstName;
    string LastName = Model.LastName;

    var locations = ViewBag.Locations as IEnumerable<Locations> ?? new List<Locations>();
    var bloodTypes = ViewBag.BloodTypes as IEnumerable<BloodTypes> ?? new List<BloodTypes>();

    string location = locations
        .FirstOrDefault(l => l.LocationId == Model.LocationId)?.Districts ?? "";

    string bloodType = bloodTypes
        .FirstOrDefault(b => b.BloodTypeId == Model.BloodTypeId)?.Type ?? "";

    string healthy = Model.IsHealthyForDonation ? "Healthy" : "Not Healthy";

    string checkIdentity = Model.IsIdentityHidden ? "Hidden" : "Not Hidden";

    string available = Model.IsAvailable ? "Available" : "Unavailable";
}
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>BloodConnect - My Profile</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
        darkMode: "class",
        theme: {
        extend: {
        colors: {
        "primary": "#d70427",
        "background-light": "#f8f9fa",
        "background-dark": "#181112",
        "action-red": "#D93B3B",
        "deep-blue": "#1E3A8A",
        "surface": "#FFFFFF",
        "charcoal": "#343A40",
        "muted-gray": "#6C757D"
        },
        fontFamily: {
        "display": ["Inter", "sans-serif"]
        },
        borderRadius: {
        "DEFAULT": "0.25rem",
        "lg": "0.75rem",
        "xl": "1rem",
        "full": "9999px"
        },
        boxShadow: {
        'soft': '0 4px 12px rgba(0, 0, 0, 0.05)',
        }
        },
        },
        }
    </script>
</head>
<body class="font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <div class="px-4 md:px-10 lg:px-20 xl:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col w-full max-w-[960px] flex-1">
                    <main class="flex flex-col gap-8 p-4 md:p-6 lg:p-10">
                        <div class="flex flex-wrap justify-between gap-3">
                            <h1 class="text-charcoal dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">My Profile</h1>
                        </div>
                        <div class="bg-surface dark:bg-gray-800 rounded-xl shadow-soft p-6 md:p-8">
                            <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-32 h-32 shrink-0 border-4 border-white dark:border-gray-700 shadow-md" data-alt="User profile picture of Alex Hunter" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDGCQ2GqLz7m7VhEo87odmmZsOEndK26IyB9c2aAo0WuM-S6JGr0qd1M5fgEBgeS7nE6qCZyulcXJiZF8v8NjysZCboFm4c_-esEU1i6uWo77l_fXKtf2N9BBE-eYlu2Gl7WxwPi_Xd2HS-ZFtwFkAy5zkyeO4IU4EgQV5-Q9cuo0GT7RWWBTpKpckoUWo3AinGuAFCliwD0hcg7hhlzNrqQ0DsM6UgXsi-TzYnhwva9G1cIR9ECoKJqGCZSIS3HHiVjw631npX5ik");'></div>
                                <div class="flex flex-col gap-4 w-full">
                                    <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left gap-2">
                                        <div class="flex flex-col">
                                            <p class="text-charcoal dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">@FirstName @LastName</p>
                                            <div class="flex items-center gap-2 justify-center md:justify-start mt-1">
                                                <span class="material-symbols-outlined text-muted-gray dark:text-gray-400 text-base">location_on</span>
                                                <p class="text-muted-gray dark:text-gray-400 text-base font-normal leading-normal">@location</p>
                                            </div>
                                        </div>
                                        <div class="bg-action-red/10 dark:bg-action-red/20 text-action-red rounded-full px-4 py-1.5 flex items-center justify-center gap-2">
                                            <span class="material-symbols-outlined text-lg">bloodtype</span>
                                            <span class="font-bold text-base">@bloodType</span>
                                        </div>
                                    </div>
                                    <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                        <div class="flex items-center gap-4">
                                            <div class="text-deep-blue dark:text-blue-300 flex items-center justify-center rounded-lg bg-deep-blue/10 dark:bg-blue-900/40 shrink-0 size-10">
                                                <span class="material-symbols-outlined">phone</span>
                                            </div>
                                            <p class="text-charcoal dark:text-gray-200 text-base font-normal leading-normal flex-1 truncate">@Model.Phone</p>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <div class="text-deep-blue dark:text-blue-300 flex items-center justify-center rounded-lg bg-deep-blue/10 dark:bg-blue-900/40 shrink-0 size-10">
                                                <span class="material-symbols-outlined">favorite</span>
                                            </div>
                                            <p class="text-charcoal dark:text-gray-200 text-base font-normal leading-normal flex-1 truncate">@healthy</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between gap-4 mt-2 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg">
                                        <label class="text-muted-gray dark:text-gray-300 text-sm font-medium" for="identity-toggle">Show my identity on public requests</label>
                                        <div class="relative inline-flex cursor-pointer items-center">
                                            <form asp-action="ToggleIdentity">
                                                <input class="peer sr-only" id="identity-toggle" type="checkbox" @(checkIdentity != "Hidden" ? "checked" : "")
                                                       onchange="this.form.submit()" />
                                                <label class="inline-flex items-center cursor-pointer">

                                                    <!-- Hidden checkbox (STATE) -->
                                                    <input type="checkbox" name="status" class="sr-only peer"
                                                    @(checkIdentity != "Hidden" ? "checked" : "")
                                                           onchange="this.form.submit()" />

                                                    <!-- SWITCH -->
                                                    <div class="relative h-6 w-11 rounded-full
                                                                bg-gray-200 dark:bg-gray-600
                                                                after:absolute after:top-0.5 after:left-0.5
                                                                after:h-5 after:w-5 after:rounded-full
                                                                after:border after:border-gray-300 after:bg-white
                                                                after:transition-all after:content-['']
                                                                peer-checked:bg-deep-blue
                                                                peer-checked:after:translate-x-full
                                                                peer-checked:after:border-white
                                                                peer-focus:ring-2 peer-focus:ring-deep-blue/50
                                                                dark:border-gray-500">
                                                    </div>

                                                </label>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <button id="editProfileBtn" class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-deep-blue text-white text-base font-medium leading-normal shadow-sm hover:bg-deep-blue/90 transition-colors">
                                <span class="material-symbols-outlined mr-2">edit</span>
                                <span class="truncate">Edit Profile</span>
                            </button>
                            <div id="modalBackdrop"
                                 class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-40">
                            </div>

                            <!-- MODAL -->
                            <div id="editProfileModal"
                                 class="fixed inset-0 flex items-center justify-center hidden z-50">

                                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg w-full max-w-lg p-4 relative">

                                    <!-- CLOSE BUTTON -->
                                    <button id="closeModal"
                                            class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-lg">
                                        ✕
                                    </button>

                                    <!-- PARTIAL VIEW LOADS HERE -->
                                    <div id="editProfileContainer"></div>
                                </div>
                            </div>

                            <button id="changePasswordBtn"
                                    class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-deep-blue text-white text-base font-medium leading-normal shadow-sm hover:bg-deep-blue/90 transition-colors">
                                <span class="material-symbols-outlined mr-2">lock</span>
                                <span class="truncate">Change Password</span>
                            </button>

                            <!-- BACKDROP -->
                            <div id="changePasswordBackdrop"
                                 class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-40">
                            </div>

                            <!-- MODAL -->
                            <div id="changePasswordModal"
                                 class="fixed inset-0 flex items-center justify-center hidden z-50">

                                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg w-full max-w-lg p-4 relative">

                                    <!-- CLOSE BUTTON -->
                                    <button id="closeChangePasswordModal"
                                            class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-lg">
                                        ✕
                                    </button>

                                    <!-- PARTIAL VIEW LOADS HERE -->
                                    <div id="changePasswordContainer"></div>
                                </div>
                            </div>
                            <button id="deleteAccountBtn"
                                    class="w-full flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-4 bg-red-600 text-white text-base font-medium leading-normal shadow-sm hover:bg-red-700 transition-colors">
                                <span class="material-symbols-outlined mr-2">delete</span>
                                <span class="truncate">Delete Account</span>
                            </button>
                            <div id="deleteAccountBackdrop"
                                 class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden z-40">
                            </div>
                            <div id="deleteAccountModal"
                                 class="fixed inset-0 flex items-center justify-center hidden z-50">

                                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-lg w-full max-w-lg p-4 relative">

                                    <!-- CLOSE BUTTON -->
                                    <button id="closeDeleteAccountModal"
                                            class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-lg">
                                        ✕
                                    </button>

                                    <!-- PARTIAL VIEW LOADS HERE -->
                                    <div id="deleteAccountContainer"></div>
                                </div>
                            </div>


                        </div>
                        <div class="bg-surface dark:bg-gray-800 rounded-xl shadow-soft p-6 text-center">
                            <p class="text-muted-gray dark:text-gray-400 mb-4">Your current status:</p>
                            <div class="inline-flex items-center gap-2 text-lg font-bold text-green-600 dark:text-green-400">
                                @if (available == "Available")
                                {
                                    <span class="relative flex h-3 w-3">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                    </span>
                                    <label>Available to Donate</label>
                                }
                                else
                                {
                                    <span class="relative flex h-3 w-3">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                    </span>
                                    <label style="color: red">Unavailable to Donate</label>
                                }
                            </div>
                            @if (available == "Available")
                            {
                                <form asp-action="ToggleAvailability">
                                    <button class="mt-6 w-full md:w-auto flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-action-red text-white text-base font-medium leading-normal shadow-sm hover:bg-action-red/90 transition-colors">
                                        <span class="material-symbols-outlined mr-2">toggle_off</span>
                                        <span class="truncate">Set as Unavailable</span>
									</button>
								</form>
                            }
                            else
                            {
                                <form asp-action="ToggleAvailability">
                                    <button class="mt-6 w-full md:w-auto flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-green-500 text-white text-base font-medium leading-normal shadow-sm hover:bg-action-green/90 transition-colors">
                                        <span class="material-symbols-outlined mr-2">toggle_on</span>
                                        <span class="truncate">Set as Available</span>
                                    </button>
                                </form>
                            }
                        </div>
                    </main>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            /* ===============================
               EDIT PROFILE MODAL
            =============================== */
            const openBtn = document.getElementById("editProfileBtn");
            const closeBtn = document.getElementById("closeModal");
            const modal = document.getElementById("editProfileModal");
            const backdrop = document.getElementById("modalBackdrop");
            const container = document.getElementById("editProfileContainer");

            if (openBtn) {
                openBtn.addEventListener("click", function () {
                    fetch('/Users/EditProfilePartial')
                        .then(res => res.text())
                        .then(html => {
                            container.innerHTML = html;
                            modal.classList.remove("hidden");
                            backdrop.classList.remove("hidden");
                            document.body.style.overflow = "hidden";
                        })
                        .catch(console.error);
                });
            }

            function closeModal() {
                modal.classList.add("hidden");
                backdrop.classList.add("hidden");
                container.innerHTML = "";
                document.body.style.overflow = "auto";
            }

            if (closeBtn) closeBtn.addEventListener("click", closeModal);
            if (backdrop) backdrop.addEventListener("click", closeModal);

            /* ===============================
               CHANGE PASSWORD MODAL
            =============================== */
            const openBtnPass = document.getElementById("changePasswordBtn");
            const closeBtnPass = document.getElementById("closeChangePasswordModal");
            const modalPass = document.getElementById("changePasswordModal");
            const backdropPass = document.getElementById("changePasswordBackdrop");
            const containerPass = document.getElementById("changePasswordContainer");

            if (openBtnPass) {
                openBtnPass.addEventListener("click", function () {
                    fetch('/Auth/ChangePasswordPartial')
                        .then(res => res.text())
                        .then(html => {
                            containerPass.innerHTML = html;
                            modalPass.classList.remove("hidden");
                            backdropPass.classList.remove("hidden");
                            document.body.style.overflow = "hidden";
                        })
                        .catch(console.error);
                });
            }

            function closeModalPass() {
                modalPass.classList.add("hidden");
                backdropPass.classList.add("hidden");
                containerPass.innerHTML = "";
                document.body.style.overflow = "auto";
            }

            if (closeBtnPass) closeBtnPass.addEventListener("click", closeModalPass);
            if (backdropPass) backdropPass.addEventListener("click", closeModalPass);

            /* ===============================
               DELETE ACCOUNT MODAL
            =============================== */
            const openBtnDelete = document.getElementById("deleteAccountBtn");
            const closeBtnDelete = document.getElementById("closeDeleteAccountModal");
            const modalDelete = document.getElementById("deleteAccountModal");
            const backdropDelete = document.getElementById("deleteAccountBackdrop");
            const containerDelete = document.getElementById("deleteAccountContainer");

            if (openBtnDelete) {
                openBtnDelete.addEventListener("click", function () {
                    fetch('/Auth/DeleteAccountPartial')
                        .then(res => res.text())
                        .then(html => {
                            containerDelete.innerHTML = html;
                            modalDelete.classList.remove("hidden");
                            backdropDelete.classList.remove("hidden");
                            document.body.style.overflow = "hidden";
                        })
                        .catch(console.error);
                });
            }

            function closeModalDelete() {
                modalDelete.classList.add("hidden");
                backdropDelete.classList.add("hidden");
                containerDelete.innerHTML = "";
                document.body.style.overflow = "auto";
            }

            if (closeBtnDelete) closeBtnDelete.addEventListener("click", closeModalDelete);
            if (backdropDelete) backdropDelete.addEventListener("click", closeModalDelete);

            /* ===============================
               GLOBAL AJAX FORM SUBMIT HANDLER
               (THIS IS THE KEY FIX)
            =============================== */
            document.addEventListener("submit", function (e) {

                const form = e.target;

                if (
                    form.id !== "editProfileForm" &&
                    form.id !== "changePasswordForm" &&
                    form.id !== "deleteAccountForm"
                ) return;

                e.preventDefault();

                fetch(form.action, {
                    method: "POST",
                    body: new FormData(form),
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                })
                .then(res => {
                    const type = res.headers.get("content-type");
                    return type && type.includes("application/json")
                        ? res.json()
                        : res.text();
                })
                .then(data => {
                    if (typeof data === "object" && data.success) {
                        window.location.href = data.redirectUrl;
                    } else {
                        if (form.id === "editProfileForm") {
                            container.innerHTML = data;
                        }
                        else if (form.id === "changePasswordForm") {
                            containerPass.innerHTML = data;
                        }
                        else {
                            containerDelete.innerHTML = data;
                        }
                    }
                })
                .catch(console.error);
            });

        });
    </script>

</body>
</html>