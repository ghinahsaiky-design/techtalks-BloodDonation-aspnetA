@{
    // This is a top-level layout, it should not use any parent layout
    Layout = null;

    var pageTitle = ViewData["Title"] as string ?? "Dashboard";
}

<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>@pageTitle - BloodConnect</title>

    <!-- Tailwind CDN with plugins -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Fonts -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" />
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" />

    <!-- Material Symbols configuration -->
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>

    <!-- Tailwind config (same as in your old Index.cshtml) -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d70427",
                        "background-light": "#f8f5f6",
                        "background-dark": "#230f12",
                        "blue-700": "#1E40AF",
                        "gray-100": "#F3F4F6",
                        "gray-800": "#1F2937",
                        "gray-500": "#6B7280",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    }
                }
            }
        };
    </script>

    @* Optional page-specific styles *@
    @RenderSection("Styles", required: false)
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-100">
    <div class="relative flex min-h-screen w-full flex-row group/design-root">

        @* LEFT SIDEBAR *@
        @Html.Partial("_Sidebar")

        @* RIGHT SIDE: HEADER + MAIN CONTENT *@
        <div class="flex flex-1 flex-col min-h-screen bg-background-light/50 dark:bg-background-dark">

            <!-- Sticky top header, copied from your old Index.cshtml -->
            <header class="flex items-center justify-between whitespace-nowrap bg-white/80 dark:bg-background-dark px-10 py-3 sticky top-0 z-10 shadow-sm">
                <div class="flex items-center gap-4 text-gray-800 dark:text-white">

                    @if (IsSectionDefined("PageHeader"))
                    {
                        @RenderSection("PageHeader")
                    }
                    else
                    {
                        var headerTitle = ViewData["Title"] as string ?? "Dashboard Overview";

                        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">
                            @headerTitle
                        </h2>
                    }

                </div>

                <div class="flex flex-1 justify-end gap-4 items-center">
                    <div class="relative">
                        <button id="notificationBtn" onclick="toggleNotificationDropdown()" class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full size-10 bg-background-light text-blue-700 dark:bg-white/10 dark:text-primary/80 hover:bg-gray-100 dark:hover:bg-white/20 transition-colors relative">
                            <span class="material-symbols-outlined">notifications</span>
                            <span id="notificationBadge" class="absolute top-1 right-1 min-w-[18px] h-[18px] bg-primary text-white text-xs font-bold rounded-full flex items-center justify-center px-1 hidden">0</span>
                        </button>
                        <div id="notificationDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-background-dark rounded-lg shadow-xl border border-gray-200 dark:border-white/10 z-50 max-h-96 overflow-y-auto">
                            <div class="p-4 border-b border-gray-200 dark:border-white/10">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-white">Recent Confirmations</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Donor confirmations from the last 24 hours</p>
                            </div>
                            <div id="notificationList" class="p-2">
                                <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                                    <span class="material-symbols-outlined animate-spin text-2xl mb-2">sync</span>
                                    <p class="text-sm">Loading...</p>
                                </div>
                            </div>
                            <div class="p-3 border-t border-gray-200 dark:border-white/10 text-center">
                                <a href="@Url.Action("RequestManagement", "Admin")" class="text-xs text-primary hover:underline">View All Requests</a>
                            </div>
                        </div>
                    </div>

                    @await Component.InvokeAsync("AdminProfileImage")
                </div>
            </header>

            <!-- MAIN CONTENT COMING FROM EACH VIEW -->
            <main class="flex-1 p-6 md:p-8 lg:p-10 bg-background-light/50 dark:bg-background-dark">
                @RenderBody()
            </main>
        </div>
    </div>

    @* Optional page-specific scripts *@
    @RenderSection("Scripts", required: false)

    @* Notification functionality - available on all pages *@
    <script>
        // Notification dropdown and badge functionality
        let notificationDropdownOpen = false;

        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                notificationDropdownOpen = !notificationDropdownOpen;
                if (notificationDropdownOpen) {
                    dropdown.classList.remove('hidden');
                    loadNotifications();
                } else {
                    dropdown.classList.add('hidden');
                }
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const btn = document.getElementById('notificationBtn');
            const dropdown = document.getElementById('notificationDropdown');
            if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
                notificationDropdownOpen = false;
            }
        });

        async function loadNotifications() {
            try {
                const response = await fetch('/Admin/GetNotificationCount');
                if (!response.ok) {
                    console.error('Failed to load notifications:', response.status);
                    return;
                }
                const data = await response.json();
                
                if (data.success) {
                    updateNotificationBadge(data.count);
                    updateNotificationList(data.confirmations || []);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function updateNotificationList(confirmations) {
            const list = document.getElementById('notificationList');
            if (!list) return;

            if (confirmations.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">notifications_off</span>
                        <p class="text-sm">No new confirmations</p>
                    </div>
                `;
                return;
            }

            const requestManagementUrl = '@Url.Action("RequestManagement", "Admin")';
            list.innerHTML = confirmations.map(conf => `
                <div class="p-3 hover:bg-gray-50 dark:hover:bg-white/5 rounded-lg cursor-pointer transition-colors" onclick="window.location.href='${requestManagementUrl}?requestId=${conf.requestId}'">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/20 flex items-center justify-center">
                            <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-sm">check_circle</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">${conf.donorName} confirmed</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Request #${conf.requestId} - ${conf.patientName} (${conf.bloodType})</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${conf.timeAgo}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load notifications on page load and refresh every 30 seconds
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            setInterval(loadNotifications, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html>
