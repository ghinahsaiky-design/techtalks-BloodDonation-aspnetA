@model BloodDonation.Models.OwnerDashboardViewModel
@{
    ViewData["Title"] = "Overview";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    // Chart Configuration
    int height = 300;
    int width = 800;
    var allValues = new List<int>();
    allValues.AddRange(Model.DailyDonations);
    allValues.AddRange(Model.DailyRegistrations);
    allValues.AddRange(Model.DailyRequests);
    var globalMax = allValues.Any() ? allValues.Max() : 10;
    if (globalMax == 0) globalMax = 10;
    globalMax = (int)(globalMax * 1.1); // 10% padding

    // Bar Chart Configuration
    int barGroupWidth = width / Model.DaysLabels.Count;
    int barWidth = (int)(barGroupWidth * 0.2); // 3 bars + spacing
    int barSpacing = 4;
}

@section PageHeader {
    <div class="flex items-center gap-4">

        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">
            Overview
        </h2>

        <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary/10 to-red-100/40 dark:from-primary/20 dark:to-primary/10 rounded-lg border border-primary/20 dark:border-primary/30">
            <span class="material-symbols-outlined text-primary text-lg">waving_hand</span>
            <span class="text-sm font-semibold text-gray-800 dark:text-white">
                <span class="text-gray-600 dark:text-gray-300">Hi,</span>
                <span class="text-primary font-bold">
                    @(ViewBag.OwnerName ?? User?.Identity?.Name ?? "Owner")
                </span>
            </span>
        </div>

    </div>
}


<main class="flex-1 p-6 md:p-8 lg:p-10 bg-background-light/50">
    <div class="flex flex-wrap justify-between items-center gap-3 mb-8">
        <div>
            <p class="text-gray-800 dark:text-white text-3xl font-black leading-tight tracking-[-0.033em]">Platform Statistics</p>
            <p class="text-gray-500 text-sm mt-1">High-level system metrics and performance indicators</p>
        </div>
        <div class="flex gap-3">
  
            <button onclick="location.href='@Url.Action("GenerateReport", "Owner")'" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg text-sm font-bold shadow-md hover:bg-primary/90">
                <span class="material-symbols-outlined text-sm">download</span>
                Generate Report
            </button>
        </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
        <div class="flex flex-col gap-4 rounded-xl p-6 border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">Total Registered Users</p>
                    <h3 class="text-gray-800 dark:text-white tracking-tight text-3xl font-bold mt-1">@Model.TotalUsers.ToString("N0")</h3>
                </div>
                <div class="p-2 bg-indigo-50 text-indigo-700 rounded-lg">
                    <span class="material-symbols-outlined">groups</span>
                </div>
            </div>
            <div class="flex items-center gap-2 mt-auto">
                <span class="@(Model.UserGrowthPercentage >= 0 ? "text-green-600 bg-green-50" : "text-red-600 bg-red-50") px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">@(Model.UserGrowthPercentage >= 0 ? "trending_up" : "trending_down")</span> 
                    @(Model.UserGrowthPercentage >= 0 ? "+" : "")@Model.UserGrowthPercentage%
                </span>
                <span class="text-gray-400 text-xs">vs last month</span>
            </div>
            <div class="flex items-end gap-1 h-8 mt-2">
                <div class="w-full bg-indigo-100 rounded-t-sm h-[30%]"></div>
                <div class="w-full bg-indigo-100 rounded-t-sm h-[40%]"></div>
                <div class="w-full bg-indigo-100 rounded-t-sm h-[50%]"></div>
                <div class="w-full bg-indigo-100 rounded-t-sm h-[70%]"></div>
                <div class="w-full bg-indigo-100 rounded-t-sm h-[60%]"></div>
                <div class="w-full bg-indigo-600 rounded-t-sm h-[90%]"></div>
            </div>
        </div>
        <div class="flex flex-col gap-4 rounded-xl p-6 border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">Total Donations</p>
                    <h3 class="text-gray-800 dark:text-white tracking-tight text-3xl font-bold mt-1">@Model.TotalDonations.ToString("N0")</h3>
                </div>
                <div class="p-2 bg-red-50 text-primary rounded-lg">
                    <span class="material-symbols-outlined">bloodtype</span>
                </div>
            </div>
            <div class="flex items-center gap-2 mt-auto">
                <span class="@(Model.DonationGrowthPercentage >= 0 ? "text-green-600 bg-green-50" : "text-red-600 bg-red-50") px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">@(Model.DonationGrowthPercentage >= 0 ? "trending_up" : "trending_down")</span> 
                    @(Model.DonationGrowthPercentage >= 0 ? "+" : "")@Model.DonationGrowthPercentage%
                </span>
                <span class="text-gray-400 text-xs">vs last month</span>
            </div>
            <div class="flex items-end gap-1 h-8 mt-2">
                <div class="w-full bg-red-100 rounded-t-sm h-[40%]"></div>
                <div class="w-full bg-red-100 rounded-t-sm h-[50%]"></div>
                <div class="w-full bg-red-100 rounded-t-sm h-[65%]"></div>
                <div class="w-full bg-red-100 rounded-t-sm h-[75%]"></div>
                <div class="w-full bg-red-100 rounded-t-sm h-[80%]"></div>
                <div class="w-full bg-primary rounded-t-sm h-[95%]"></div>
            </div>
        </div>
        <div class="flex flex-col gap-4 rounded-xl p-6 border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">Active Hospitals</p>
                    <h3 class="text-gray-800 dark:text-white tracking-tight text-3xl font-bold mt-1">@Model.TotalHospitals</h3>
                </div>
                <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
                    <span class="material-symbols-outlined">local_hospital</span>
                </div>
            </div>
            <div class="flex items-center gap-2 mt-auto">
                <span class="text-blue-600 bg-blue-50 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">add</span> 3 New
                </span>
                <span class="text-gray-400 text-xs">this month</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2.5 mt-auto">
                <div class="bg-purple-600 h-2.5 rounded-full" style="width: 75%"></div>
            </div>
        </div>
        <div class="flex flex-col gap-4 rounded-xl p-6 border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium leading-normal">System Blood Stock</p>
                    <h3 class="text-gray-800 dark:text-white tracking-tight text-3xl font-bold mt-1">88%</h3>
                </div>
                <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                    <span class="material-symbols-outlined">inventory_2</span>
                </div>
            </div>
            <div class="flex items-center gap-2 mt-auto">
                <span class="text-green-600 bg-green-50 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1">
                    Status: Healthy
                </span>
                <span class="text-gray-400 text-xs">Optimum level</span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-2.5 mt-auto">
                <div class="bg-green-600 h-2.5 rounded-full" style="width: 88%"></div>
            </div>
        </div>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 rounded-xl border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-lg font-bold text-gray-800 dark:text-white">Platform Activity Trends (Last 7 Days)</h4>
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-2 text-xs text-gray-500"><div class="w-3 h-3 rounded-sm bg-primary"></div> Donations</span>
                    <span class="flex items-center gap-2 text-xs text-gray-500"><div class="w-3 h-3 rounded-sm bg-blue-500"></div> Registrations</span>
                    <span class="flex items-center gap-2 text-xs text-gray-500"><div class="w-3 h-3 rounded-sm bg-gray-300"></div> Requests</span>
                </div>
            </div>
            <div class="flex-1 w-full h-[320px] relative">
                <svg class="w-full h-full overflow-visible" viewBox="0 0 800 300">
                    <!-- Grid Lines -->
                    <line stroke="#f3f4f6" stroke-width="1" x1="0" x2="800" y1="250" y2="250"></line>
                    <line stroke="#f3f4f6" stroke-width="1" x1="0" x2="800" y1="200" y2="200"></line>
                    <line stroke="#f3f4f6" stroke-width="1" x1="0" x2="800" y1="150" y2="150"></line>
                    <line stroke="#f3f4f6" stroke-width="1" x1="0" x2="800" y1="100" y2="100"></line>
                    <line stroke="#f3f4f6" stroke-width="1" x1="0" x2="800" y1="50" y2="50"></line>
                    
                    @for (int i = 0; i < Model.DaysLabels.Count; i++)
                    {
                        var xBase = i * barGroupWidth + (barGroupWidth - (barWidth * 3 + barSpacing * 2)) / 2;
                        
                        // Donations Bar
                        var donationHeight = (double)Model.DailyDonations[i] / globalMax * 250;
                        var donationY = 250 - donationHeight;
                        <rect x="@xBase" y="@donationY" width="@barWidth" height="@donationHeight" fill="#d70427" rx="2" class="opacity-80 hover:opacity-100 transition-opacity cursor-pointer">
                            <title>@Model.DaysLabels[i]: @Model.DailyDonations[i] Donations</title>
                        </rect>

                        // Registrations Bar
                        var regHeight = (double)Model.DailyRegistrations[i] / globalMax * 250;
                        var regY = 250 - regHeight;
                        <rect x="@(xBase + barWidth + barSpacing)" y="@regY" width="@barWidth" height="@regHeight" fill="#3b82f6" rx="2" class="opacity-80 hover:opacity-100 transition-opacity cursor-pointer">
                            <title>@Model.DaysLabels[i]: @Model.DailyRegistrations[i] Registrations</title>
                        </rect>

                        // Requests Bar
                        var reqHeight = (double)Model.DailyRequests[i] / globalMax * 250;
                        var reqY = 250 - reqHeight;
                        <rect x="@(xBase + (barWidth + barSpacing) * 2)" y="@reqY" width="@barWidth" height="@reqHeight" fill="#d1d5db" rx="2" class="opacity-80 hover:opacity-100 transition-opacity cursor-pointer">
                            <title>@Model.DaysLabels[i]: @Model.DailyRequests[i] Requests</title>
                        </rect>
                    }
                </svg>
                <div class="flex justify-between text-xs text-gray-400 mt-2 px-2">
                    @foreach(var day in Model.DaysLabels)
                    {
                        <span style="width: @(100.0/7)% ; text-align: center;">@day</span>
                    }
                </div>
            </div>
        </div>
        <div class="rounded-xl border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm p-6 flex flex-col">
            <h4 class="text-lg font-bold text-gray-800 dark:text-white mb-6">User Role Distribution</h4>
            <div class="flex flex-col items-center justify-center flex-1">
                <div class="relative w-48 h-48 rounded-full mb-8 shadow-inner" style="background: conic-gradient(
                                #d70427 0% 65%,
                                #2563EB 65% 85%,
                                #F59E0B 85% 95%,
                                #6B7280 95% 100%
                             );">
                    <div class="absolute inset-0 m-auto w-32 h-32 bg-white dark:bg-background-dark rounded-full flex flex-col items-center justify-center shadow-sm">
                        <span class="text-gray-400 text-xs font-medium">Total Users</span>
                        <span class="text-2xl font-bold text-gray-800 dark:text-white">@Model.TotalUsers.ToString("N0")</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-x-8 gap-y-4 w-full px-2">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-primary"></div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500">Donors</span>
                            @{
                                var donorPercent = Model.TotalUsers > 0 ? (Model.TotalDonors * 100 / Model.TotalUsers) : 0;
                            }
                            <span class="text-sm font-bold">@donorPercent%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-blue-600"></div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500">Hospitals</span>
                            @{
                                var hospitalPercent = Model.TotalUsers > 0 ? (Model.TotalHospitals * 100 / Model.TotalUsers) : 0;
                            }
                            <span class="text-sm font-bold">@hospitalPercent%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500">Admins</span>
                            @{
                                var adminPercent = Model.TotalUsers > 0 ? (Model.TotalAdmins * 100 / Model.TotalUsers) : 0;
                            }
                            <span class="text-sm font-bold">@adminPercent%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                        <div class="flex flex-col">
                            <span class="text-xs text-gray-500">Owners</span>
                            @{
                                var ownerPercent = Model.TotalUsers > 0 ? (Model.TotalOwners * 100 / Model.TotalUsers) : 0;
                            }
                            <span class="text-sm font-bold">@ownerPercent%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Admin Actions -->
    <div class="mt-8 rounded-xl border border-gray-100 dark:border-white/10 bg-white dark:bg-background-dark shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h4 class="text-lg font-bold text-gray-800 dark:text-white">Recent Admin Actions</h4>
                <p class="text-sm text-gray-500 mt-1">Latest activities performed by administrators</p>
            </div>
            <a asp-action="AdminActions" class="text-sm font-medium text-primary hover:text-primary/80 flex items-center gap-1">
                View All <span class="material-symbols-outlined text-sm">arrow_forward</span>
            </a>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-white/5">
                    <tr>
                        <th class="px-4 py-3 rounded-l-lg">Action</th>
                        <th class="px-4 py-3">Admin</th>
                        <th class="px-4 py-3">Details</th>
                        <th class="px-4 py-3 rounded-r-lg text-right">Time</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-white/10">
                    @if (Model.RecentActions != null && Model.RecentActions.Any())
                    {
                        @foreach (var action in Model.RecentActions)
                        {
                            <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                                <td class="px-4 py-3 font-medium text-gray-900 dark:text-white">@action.Name</td>
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xs font-bold">
                                            @action.PerformedByUser.FirstName.Substring(0,1)
                                        </div>
                                        <span>@action.PerformedByUser.FirstName @action.PerformedByUser.LastName</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-gray-500">@(action.Description ?? "-")</td>
                                <td class="px-4 py-3 text-right text-gray-400">@action.PerformedAt.ToString("MMM dd, HH:mm")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                No recent actions found.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</main>